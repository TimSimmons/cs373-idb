{% extends "base.html" %}
{% load staticfiles %}
{% block title %} - {{ player.name }}{% endblock %}
{% block content %}
<div class="container">
  <div class="jumbotron">
   <div class = "container-fluid">
     <div class="row">
      <h1> {{ player.name }}  </h1>
      <h2>#{{ player.number }}</h2>
    </div>
    <div class = "row">
      <div class="col-md-4">
       <img src=" {{ player.images.all.0.image }} " class="img-responsive"><br>
     </div>
     <div class="col-md-4">
        <script src="Chart.js"></script>
        <canvas id="spiderChart" width="200" height="200"></canvas>
        <script type="text/javascript">
            // maybe this works...???
            function makeChart(player) {
                var ctx = document.getElementById("spiderChart").getContext("2d");
                var data = {};
                if (player.position != "P") {
                  // data for batter
                  var total_pa = 0;
                  var ba = 0;
                  var avg = 0;
                  var slg = 0;
                  var count = 0
                  for (var year in player.years.all) {
                      count += 1;
                      total_pa += year.pa;
                      ba += year.ba * year.pa;
                      obp += year.obp * year.pa;
                      slg += year.slg * year.pa;
                  }
                  ba /= total_pa;
                  obp /= total_pa;
                  slg /= total_pa;
                  data = {
                    labels : ["Batting Avg","On Base %","Slugging %"],
                    datasets : [
                      {
                        fillColor : "rgba(220,220,220,0.5)",
                        strokeColor : "rgba(220,220,220,1)",
                        pointColor : "rgba(220,220,220,1)",
                        pointStrokeColor : "#fff",
                        // normalizing because chart uses 100 for max vals
                        data : [ba * 100, obp * 100, slg * 100]
                      },
                      {
                        // These are the record PA, OBP, SLUG %
                        fillColor : "rgba(151,187,205,0.5)",
                        strokeColor : "rgba(151,187,205,1)",
                        pointColor : "rgba(151,187,205,1)",
                        pointStrokeColor : "#fff",
                        data : [36.6, 48.17, 69.97]
                      }
                    ]
                  }
                }
                else {
                  var whip = 0;
                  var wins = 0;
                  var losses = 0;
                  var game_saves_per_year = 0;
                  var total_ip = 0;
                  var count = 0;
                  for (var year in player.years.all) {
                    total_ip += year.ip;
                    count +=1;
                    wins += year.w;
                    losses += year.l;
                    game_saves += year.gs;
                    whip += year.whip * year.ip;
                  }
                  var games_total = wins+losses;
                  game_saves_per_year = game_saves/count;
                  var win_perc = wins/games_total;
                  // Best Whip .9678
                  whip /= total_ip;
                  whip = 100 - (100 * (0.9678 - whip))
                  gsp_record = 652/19;
                  data = {
                    labels : ["Win %","WHIP","Game Saves per Season"],
                    datasets : [
                      {
                        fillColor : "rgba(220,220,220,0.5)",
                        strokeColor : "rgba(220,220,220,1)",
                        pointColor : "rgba(220,220,220,1)",
                        pointStrokeColor : "#fff",
                        // normalizing becasue chart uses 100 for max vals
                        data : [win_perc * 100, whip, game_saves_per_year]
                      }
                    ],
                    // These are the records holders' stats
                        fillColor : "rgba(151,187,205,0.5)",
                        strokeColor : "rgba(151,187,205,1)",
                        pointColor : "rgba(151,187,205,1)",
                        pointStrokeColor : "#fff",
                        data : [71.7 , 100, 652/19]
                  }
                }
                var myNewChart = new Chart(ctx).Radar(data);
            }
            
            // A way to add a method callback to the load event without
            // overwriting existing onload callbacks
            function addLoadEvent(func) {
                var oldonload = window.onload;
                if (typeof window.onload != 'function') {
                  window.onload = func;
                } else {
                  window.onload = function() {
                    if (oldonload) {
                      oldonload();
                    }
                    func();
                  }
                }
              }
              addLoadEvent(function() {
                // Maybe we can get the player object this way?
                var player = "{{ player }}";
                console.log(player);
                makeChart(player);
              });
            
        </script>
     </div>
     <div class="col-md-2">
      Position: {{player.position}}<br>
      Bats: {{player.bats}}<br>
      Throws: {{player.throws}}<br>
      Height: {{player.height}}<br>
      Weight: {{player.weight}}<br>
      School: {{player.school}}<br>
    </div>
    <div class="container-fluid">
      <div class="col-md-3">

        <a class="twitter-timeline"  width="300" height="300" data-dnt="true" href="https://twitter.com/{{player.social}}"
        data-widget-id="446046951486676992"
        data-screen-name="{{player.social|slice:"1:"}}" data-show-replies="false"
        >Tweets by {{social}}</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      </div>
      <div class="col-md-3">
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script><div style="width:300px;"><div style="overflow:hidden;height:300px;width:300px;"><div id="gmap_canvas" style="height:300px; width:300px;"></div><style>.gmap{position:relative;line-height:1.12;overflow:hidden;color:#000;white-space:nowrap;display:block;margin-bottom:2px;font-weight:500;}</style><iframe src="http://www.embed-google-map.com/addmap.php"><a href="http://www.addlikebutton.net" class="map-data">addlikebutton.net</a></iframe></div>

        <script type="text/javascript">

        function httpGet(theUrl) {
          var xmlHttp = null;

          xmlHttp = new XMLHttpRequest();
          xmlHttp.open("GET", theUrl, false);
          xmlHttp.send(null);
          return xmlHttp.responseText;
        }



        function init_map(){
          var address = encodeURIComponent("{{player.school}}")
          var jsonResponse = jQuery.parseJSON(httpGet("https://maps.googleapis.com/maps/api/geocode/json?address="+address+"&sensor=false&key=AIzaSyBActeEqWee-gv7iH32gAfTpUbfMzym2uA"))
          var lat = jsonResponse.results[0].geometry.location.lat
          var lng = jsonResponse.results[0].geometry.location.lng
          var myOptions = {zoom:14,center:new google.maps.LatLng(lat,lng),mapTypeId: google.maps.MapTypeId.ROADMAP};
          map = new google.maps.Map(document.getElementById("gmap_canvas"), myOptions);marker = new google.maps.Marker(
            {map: map,position: new google.maps.LatLng(lat, lng)});
          infowindow = new google.maps.InfoWindow(
            {content:"<span class='gmap'><b>{{park}}</b></span><span class='gmap'>"+jsonResponse.results[0].address_components[1].long_name+" "+jsonResponse.results[0].address_components[2].long_name+"</span><span class='gmap'> "+jsonResponse.results[0].address_components[3].long_name+","+jsonResponse.results[0].address_components[4].long_name+"</span>" });google.maps.event.addListener(marker, "click", function(){infowindow.open(map,marker);});infowindow.open(map,marker);}google.maps.event.addDomListener(window, "load", init_map);
          </script>




        </div>
      </div>
    </div>

    <div class="row">
      <div class="container-fluid">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <b>
                  {% if player.years.all.0.kind == "hitter" %}
                  <th>Year</th><th>Team</th><th>G</th><th>PA</th><th>BA</th><th>OBP</th><th>SLG</th><th>HR</th><th>RBI</th>
                  {% else %}
                  <th>Year</th><th>Team</th><th>W</th><th>L</th><th>G</th><th>GS</th><th>S</th><th>IP</th><th>WHIP</th>
                  {% endif %}
                </b>
              </tr>
            </thead>

            <tbody>
              {% for year in player.years.all %}
              <tr>
                {% if year.kind == "hitter" %}
                <td><a href="{{ year.year.gen_link }}">{{ year.year.year }}</a></td><td><a href="{{ year.team_year.team.gen_link}}"> {{ year.team_year.team.abbr }} </a></td><td> {{ year.games }}</td><td>{{ year.pa }}</td><td>{{ year.avg }}</td><td>{{ year.obp }}</td><td>{{ year.slg }}</td><td>{{ year.hr }}</td><td>{{ year.rbi }}</td>

                {% else %}
                <td>{{ year.year.year }}</td><td> {{year.team }} </td><td>{{ year.w }}</td><td>{{ year.l }}</td><td> {{ year.games }}</td><td> {{ year.gs }}</td><td> {{ year.s }}</td><td>{{ year.ip }}</td><td>{{ year.whip }}</td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>


      </div>
    </div>
  </div>
</div>
{% endblock %}
